<!DOCTYPE html>
<html>
<head>
    <title>CloudFlare Latency Test</title>
</head>
<body>
    <h1>Edge Latency Tester</h1>
    <button id="testBtn">Run Test</button>
    <pre id="output"></pre>

    <script>
        async function measureEdgeLatency() {
            let iterations = 5;
            let avg_rtt = 0;
            let data = null;
            let min_rtt = Infinity;
            let max_rtt = -Infinity;
            let diff_sum = 0;
            let jitter = 0;
            let prev = null;

            var today = new Date();
            var dd = String(today.getDate()).padStart(2, '0');
            var mm = String(today.getMonth() + 1).padStart(2, '0');
            var yyyy = today.getFullYear();

            var hh = String(today.getHours()).padStart(2, '0');
            var mmn = String(today.getMinutes()).padStart(2, '0');
            var ss = String(today.getSeconds()).padStart(2, '0');

            var timestamp = mm + '/' + dd + '/' + yyyy + ' ' + hh + ':' + mmn + ':' + ss;
            document.getElementById("output").textContent = `Test run at: ${timestamp}\n\n`;

            for (let i = 0; i < iterations; i++) {
                let start = performance.now();
                let res = await fetch("/ping");
                let end = performance.now();
                
                data = await res.json();
                let rtt = end - start;

                avg_rtt = avg_rtt + (rtt - avg_rtt) / (i + 1);

                if (prev !== null) {
                    let diff = Math.abs(rtt - prev);
                    diff_sum += diff;
                    jitter = diff_sum / i;

                }
                prev = rtt;

                document.getElementById("output").textContent += `Ping ${i+1}: ${rtt.toFixed(2)} ms\n`;
            }

            document.getElementById("output").textContent +=
                `\n=== Summary ===\n` +
                `Average RTT: ${avg_rtt.toFixed(2)} ms\n` +
                `Jitter: ${jitter.toFixed(2)} ms\n` + 
                `ASN: ${data.asn}\n` +
                `Country: ${data.country}\n` +
                `City: ${data.city}\n` +
                `PoP: ${data.colo}`;
        }

        document.getElementById("testBtn").addEventListener("click", measureEdgeLatency);
    </script>
</body>



</html>